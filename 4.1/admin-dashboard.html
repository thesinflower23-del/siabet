<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <title>Admin Dashboard - BestBuddies Pet Grooming</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/custom-alert.css">
  <link rel="stylesheet" href="css/loading-screens.css">
  <link rel="stylesheet" href="css/admin-dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
  <header>
    <nav>
      <a class="logo" href="index.html">
        <img src="assets/logo.png" alt="BestBuddies logo" class="logo-mark">
        <div class="logo-text">
          <span class="logo-wordmark">BestBuddies Pet Grooming</span>
        </div>
      </a>
      <button class="menu-toggle" aria-label="Toggle menu">â˜°</button>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="reviews.html">Testimony</a></li>
        <li><a href="#" onclick="logout(event)">Logout</a></li>
      </ul>
    </nav>
    <div class="mobile-drawer-overlay"></div>
    <div class="mobile-drawer">
      <div class="mobile-drawer-header">
        <a class="logo" href="index.html" style="display: flex; align-items: center; gap: 0.85rem;">
          <img src="assets/logo.png" alt="BestBuddies logo" class="logo-mark" style="width: 48px; height: 48px;">
          <div class="logo-text">
            <span class="logo-wordmark" style="font-size: 1rem;">BestBuddies Pet Grooming</span>
          </div>
        </a>
        <button class="mobile-drawer-close" aria-label="Close menu">Ã—</button>
      </div>
      <ul class="mobile-drawer-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="reviews.html">Testimony</a></li>
        <li><a href="#" onclick="logout(event)">Logout</a></li>
      </ul>
    </div>
  </header>

  <!-- Dashboard Header - Fixed below navbar -->
  <div class="dashboard-header-fixed"
    style="background: #f5f5f5; position: sticky; top: 58px; z-index: 500; padding: 1rem 2rem; border-bottom: 1px solid #e0e0e0; width: 100%;">
    <div style="max-width: 100%; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="dashboard-title" style="margin: 0; font-size: 1.5rem;">
          ğŸ‘¨â€ğŸ’¼ Admin Dashboard
        </h1>
        <p style="color: var(--gray-600); margin-top: 0.25rem; font-size: 1rem; margin-bottom: 0;">
          Manage bookings, customers, and appointments
        </p>
      </div>
      <!-- Notification Bell -->
      <div id="adminNotificationBell" style="position: relative; cursor: pointer;" onclick="openNotificationPanel()">
        <i class="bi bi-bell-fill" style="font-size: 1.5rem; color: var(--gray-700);"></i>
        <span id="notificationBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 50%; min-width: 18px; text-align: center;">0</span>
      </div>
    </div>
  </div>
  
  <!-- Notification Panel (hidden by default) -->
  <div id="notificationPanel" style="display: none; position: fixed; top: 120px; right: 20px; width: 350px; max-height: 450px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; overflow: hidden;">
    <div style="padding: 1rem; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
      <h4 style="margin: 0; font-size: 1rem;"><i class="bi bi-bell"></i> Notifications</h4>
      <button onclick="closeNotificationPanel()" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--gray-500);">&times;</button>
    </div>
    <div id="notificationList" style="max-height: 320px; overflow-y: auto; padding: 0.5rem;"></div>
    <div style="padding: 0.75rem; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; gap: 0.5rem;">
      <button onclick="markAllNotificationsAsRead()" style="flex: 1; padding: 0.5rem; background: #4caf50; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
        <i class="bi bi-check-all"></i> Mark All Read
      </button>
      <button onclick="clearSeenNotifications()" style="flex: 1; padding: 0.5rem; background: #ff9800; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
        <i class="bi bi-arrow-counterclockwise"></i> Reset
      </button>
    </div>
  </div>

  <main>
    <div class="container-lg" id="adminDashboard">
      <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem;" class="admin-layout" id="adminLayout">
        <!-- Sidebar -->
        <div class="sidebar"
          style="background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; height: fit-content;">
          <ul class="sidebar-menu" style="list-style: none; padding: 0; margin: 0;">
            <li style="margin-bottom: 0.5rem;">
              <a href="#" data-view="overview" class="active"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                ğŸ“Š Dashboard Overview
              </a>
            </li>

            <!-- Bookings Collapsible Section -->
            <li style="margin-bottom: 0.5rem;">
              <div id="sidebar-bookings" class="sidebar-section collapsible open"
                onclick="toggleSidebarSection('bookings')">
                <span>ğŸ“… Bookings</span>
                <span class="dropdown-arrow">â–¼</span>
              </div>
              <div id="submenu-bookings" class="sidebar-submenu open">
                <a href="#" data-view="pending">â³ Pending Bookings</a>
                <a href="#" data-view="confirmed">âœ… Confirmed Bookings</a>
                <a href="#" data-view="inprogress">ğŸ”„ In Progress</a>
                <a href="#" data-view="addons">â• Add-ons</a>
              </div>
            </li>
            <li style="margin-bottom: 0.5rem;">
              <a href="#" data-view="calendar"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                ğŸ“… Calendar View
              </a>
            </li>

            <!-- Management Collapsible Section (Records & Analytics) -->
            <li style="margin-bottom: 0.5rem;">
              <div id="sidebar-management" class="sidebar-section collapsible"
                onclick="toggleSidebarSection('management')">
                <span>ğŸ—‚ï¸ Management</span>
                <span class="dropdown-arrow">â€º</span>
              </div>
              <div id="submenu-management" class="sidebar-submenu">
                <a href="#" data-view="customers">ğŸ‘¥ Customer Management</a>
                <a href="#" data-view="groomerWorkload">âš–ï¸ Groomer Workload</a>
                <a href="#" data-view="bookinghistory">ğŸ“– Booking History</a>
                <a href="#" data-view="gallery">ğŸ“¸ Featured Gallery</a>
              </div>
            </li>

            <li style="margin-bottom: 0.5rem;">
              <a href="#" data-view="groomerAbsences"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                ğŸ§‘â€âš•ï¸ Groomer Absences
              </a>
            </li>
            <li style="margin-bottom: 0.5rem;">
              <a href="#" data-view="gallery"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                â­ Reviews (Before & After)
              </a>
            </li>
            <li style="margin-bottom: 0.5rem;">
              <a href="booking.html?source=admin"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                â• Walk-In Appointment
              </a>
            </li>
            <li style="margin-bottom: 0.5rem;">
              <a href="#" data-view="account"
                style="display: block; padding: 0.75rem 1rem; border-radius: var(--radius-sm); transition: var(--transition); color: var(--gray-700); font-weight: 500; text-decoration: none;">
                ğŸ”’ Change Password
              </a>
            </li>
          </ul>
          <div class="sidebar-panel" style="margin-top:1.5rem;">
            <h4 style="margin-bottom:0.75rem;">Pending Groomer Absences</h4>
            <div id="staffAlertPanel">
              <p class="empty-state" style="margin:0;">All caught up!</p>
            </div>
          </div>
          <div class="sidebar-panel"
            style="margin-top:1.5rem; padding-top:1.5rem; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom:0.75rem;">ğŸ“¸ Featured Cuts</h4>
            <div id="featuredCutsPanel">
              <p class="empty-state" style="margin:0; font-size:0.85rem;">Loading...</p>
            </div>
          </div>
          <div class="sidebar-panel"
            style="margin-top:1.5rem; padding-top:1.5rem; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom:0.75rem;">ğŸš« Blocked Customers</h4>
            <div id="blockedCustomersPanel">
              <p class="empty-state" style="margin:0; font-size:0.85rem;">No blocked customers</p>
            </div>
          </div>
          <div class="sidebar-panel"
            style="margin-top:1.5rem; padding-top:1.5rem; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom:0.75rem;">âœ… Approved Lift Ban</h4>
            <div id="liftBanPanel">
              <p class="empty-state" style="margin:0; font-size:0.85rem;">No lift ban requests</p>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div>
          <!-- Overview Section -->
          <div id="overviewView">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ“Š Dashboard Overview</h2>

            <div class="stats-grid" style="margin-bottom: 2rem;" id="statsCardsContainer">
              <!-- Stats cards will be loaded here -->
            </div>

            <div style="margin-top: 2rem;">
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <h3 style="margin: 0; color: var(--gray-900);">ğŸ“‹ Recent Bookings</h3>
                <div class="booking-filter-group">
                  <label style="color: var(--gray-600); font-weight: 500;">Show:</label>
                  <select id="recentBookingsFilter" onchange="changeRecentBookingsLimit(this.value)"
                    class="booking-filter-select">
                    <option value="3">3</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="all">All</option>
                  </select>
                  <span style="color: var(--gray-600); font-weight: 500;">entries</span>
                </div>
              </div>
              <div id="recentBookings">
                <!-- Recent bookings will be loaded here -->
              </div>
              <div id="recentPagination" style="margin-top:1rem;"></div>
            </div>

            <div style="margin-top: 2rem;">
              <h3 style="margin-bottom: 1rem; color: var(--gray-900);">ğŸ“… Booking Calendar</h3>
              <div id="adminCalendar"></div>
            </div>

            <div style="margin-top: 2rem;">
              <h3 style="margin-bottom: 1rem; color: var(--gray-900);">ğŸ’¬ Community Grooming Feed</h3>
              <div id="adminReviewFeed" class="review-feed-grid">
                <!-- Review feed populated via JS -->
              </div>
            </div>
          </div>

          <!-- Pending Bookings Section -->
          <div id="pendingView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">â³ Pending Bookings</h2>

            <div class="search-bar">
              <input type="text" id="pendingSearch" class="search-input"
                placeholder="ğŸ” Search by customer name, pet name, or package...">
            </div>

            <div id="pendingBookingsTable" style="margin-top: 1.5rem;">
              <!-- Pending bookings table will be loaded here -->
            </div>
          </div>

          <!-- Confirmed Bookings Section -->
          <div id="confirmedView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">âœ… Confirmed Bookings</h2>

            <div id="confirmedBookingsTable" style="margin-top: 1rem;">
              <!-- Confirmed bookings table will be loaded here -->
            </div>
          </div>

          <!-- In Progress Bookings Section -->
          <div id="inprogressView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ”„ In Progress</h2>

            <div id="inprogressBookingsTable" style="margin-top: 1rem;">
              <!-- In progress bookings table will be loaded here -->
            </div>
          </div>

          <!-- Booking History Section -->
          <div id="bookinghistoryView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ“– Booking History</h2>

            <div id="bookingHistoryTableContainer" style="margin-top: 1.5rem;">
              <!-- Booking history table will be loaded here -->
            </div>
          </div>

          <!-- Calendar View Section -->
          <div id="calendarView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ“… Calendar View</h2>

            <div class="card" style="margin-bottom: 2rem;">
              <div class="form-group">
                <label for="calendarDate" class="form-label">ğŸ“† Select Date</label>
                <input type="date" id="calendarDate" class="calendar-input">
              </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
              <div class="form-group">
                <label for="calendarBlockReason" class="form-label">Reason for closing (optional)</label>
                <input type="text" id="calendarBlockReason" class="form-input"
                  placeholder="e.g. Deep cleaning, Holiday schedule">
              </div>
              <div class="form-actions" style="display:flex; flex-wrap:wrap; gap:0.75rem;">
                <button id="calendarBlockBtn" class="btn btn-danger">ğŸš« Block selected day</button>
                <button id="calendarUnblockBtn" class="btn btn-outline">âœ… Re-open selected day</button>
              </div>
              <p id="calendarBlockStatus" class="form-hint" style="margin-top:0.5rem;"></p>
            </div>

            <div class="card" style="margin-bottom:2rem;">
              <h4 style="margin-bottom:0.75rem;">Upcoming closed days</h4>
              <div id="calendarBlackoutList" class="empty-state">No closed days yet.</div>
            </div>

            <div id="calendarAppointments">
              <!-- Appointments will be loaded here -->
            </div>
          </div>

          <!-- Customer Management Section -->
          <div id="customersView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ‘¥ Customer Management</h2>

            <div id="customersTable" style="margin-top: 1rem;">
              <!-- Customers table will be loaded here -->
            </div>
          </div>

          <!-- Groomer Workload Section -->
          <div id="groomerWorkloadView" style="display: none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">âš–ï¸ Groomer Workload Distribution</h2>
            <p style="color: var(--gray-600); margin-bottom: 2rem;">Monitor fair distribution of bookings across all groomers. The system automatically assigns bookings to groomers with the least workload.</p>
            
            <!-- Date Selector -->
            <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <label style="font-weight: 600; color: var(--gray-900);">View Date:</label>
                <input type="date" id="workloadDatePicker" class="form-input" style="width: auto;" onchange="loadGroomerWorkload()">
                <button class="btn btn-outline btn-sm" onclick="setWorkloadDateToday()">Today</button>
                <button class="btn btn-outline btn-sm" onclick="setWorkloadDateTomorrow()">Tomorrow</button>
              </div>
            </div>

            <!-- Workload Stats -->
            <div id="groomerWorkloadStats" style="margin-bottom: 2rem;">
              <!-- Stats will be loaded here -->
            </div>

            <!-- Groomer Cards -->
            <div id="groomerWorkloadCards">
              <!-- Groomer workload cards will be loaded here -->
            </div>


          </div>

          <!-- Add-ons Management Section -->
          <div id="addonsView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h2 style="margin: 0; color: var(--gray-900);">ğŸ› Add-on Services</h2>
              <button class="btn btn-primary" onclick="handleAddonCreate()">+ New Add-on</button>
            </div>
            <div id="addonsTable">
              <!-- Add-ons table will be loaded here -->
            </div>
          </div>

          <!-- Groomer Absence Section -->
          <div id="groomerAbsencesView" style="display:none;">
            <h2 style="margin-bottom:1.5rem; color: var(--gray-900);">ğŸ§‘â€âš•ï¸ Groomer Absence Requests</h2>
            <div id="groomerAbsenceTable"></div>
          </div>



          <!-- Booking History Section -->
          <div id="historyView" style="display:none;">
            <h2 style="margin-bottom:1.5rem; color:var(--gray-900);">ğŸ§¾ Booking History</h2>
            <div id="historyControls"></div>
            <div id="bookingHistoryTable"></div>
          </div>

          <!-- Featured Gallery Section -->
          <div id="galleryView" style="display:none;">
            <h2 style="margin-bottom:1.5rem; color:var(--gray-900);">ğŸ“¸ Featured Gallery Manager</h2>
            <p style="color:var(--gray-600); margin-bottom:1.5rem;">Upload before & after images for confirmed bookings,
              then feature them to display on the home page.</p>

            <!-- Filter by status -->
            <div style="margin-bottom:1.5rem;">
              <label style="color:var(--gray-700); font-weight:600;">Filter: </label>
              <select id="galleryStatusFilter" onchange="loadGalleryView()"
                style="padding:0.5rem; border:1px solid var(--gray-300); border-radius:0.25rem;">
                <option value="confirmed">Confirmed Bookings Only</option>
                <option value="all">All with Images</option>
              </select>
            </div>

            <!-- Gallery grid -->
            <div id="galleryGrid"
              style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
              <p class="empty-state">Loading bookings...</p>
            </div>
          </div>

          <!-- Account Section -->
          <div id="accountView" style="display:none;">
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-900);">ğŸ”’ Change Password</h2>
            <div class="card" style="max-width: 600px;">
              <div class="card-body">
                <form id="adminPasswordForm">
                  <div class="form-group">
                    <label for="adminCurrentPassword" class="form-label">Current Password</label>
                    <input type="password" id="adminCurrentPassword" class="form-input" required>
                  </div>
                  <div class="form-group">
                    <label for="adminNewPassword" class="form-label">New Password</label>
                    <input type="password" id="adminNewPassword" class="form-input" minlength="6" required>
                  </div>
                  <div class="form-group">
                    <label for="adminConfirmPassword" class="form-label">Confirm New Password</label>
                    <input type="password" id="adminConfirmPassword" class="form-input" minlength="6" required>
                  </div>
                  <button type="submit" class="btn btn-primary" style="width:100%;">Update Password</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Yen's Pet Shop. All rights reserved.</p>
      <p style="margin-top: 0.5rem; font-size: 0.9rem;">ğŸ“ 0951 986 5882 | âœ‰ï¸ yenspetshop@gmail.com</p>
    </div>
  </footer>

  <div id="modalRoot"></div>

  <script type="module" src="js/firebase-config.js"></script>
  <script type="module" src="js/firebase-db.js"></script>
  <script type="module" src="js/booking-server.js"></script>
  <script src="js/booking-error-handler.js"></script>
  <script src="js/main.js"></script>
  <script src="js/custom-alert.js"></script>
  <script type="module" src="js/auth.js"></script>
  
  <!-- Loading Manager -->
  <script src="js/loading-manager.js"></script>
  
  <!-- Console Manager -->
  <script src="js/console-manager.js"></script>
  
  <!-- Permission Handler -->
  <script src="js/permission-handler.js"></script>
  
  <!-- Modal System for Admin Dashboard -->
  <script src="js/modal-system.js"></script>
  
  <script src="js/admin.js"></script>

  <script type="module">
    import { getCurrentUser, setCurrentUser } from './js/firebase-db.js';
    import { ref, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // Helper for dev: Promote self to admin
    window.promoteMeToAdmin = async function () {
      const user = await getCurrentUser();
      if (!user) {
        alert('You must be logged in first!');
        return;
      }
      if (confirm(`Promote user ${user.name} (${user.email}) to Admin?`)) {
        try {
          const db = window.firebaseDatabase;
          if (!db) throw new Error('Database not initialized');

          await update(ref(db, `users/${user.id}`), { role: 'admin' });

          user.role = 'admin';
          setCurrentUser(user);
          alert('Success! You are now an Admin. Reloading...');
          location.reload();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }
    };

    // Log instructions to console
    console.log("%c Admin Tools Loaded ", "background: #222; color: #bada55");
    console.log("If you are not an admin and cannot run repair, run: promoteMeToAdmin()");
  </script>
</body>

</html>